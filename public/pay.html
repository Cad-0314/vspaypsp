<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payment</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
        }

        .amount-section {
            padding: 3rem 1.5rem 2rem;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .amount {
            font-size: 3rem;
            font-weight: 700;
            color: #111;
            letter-spacing: -1px;
        }

        .amount-label {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .timer {
            background: #fffbeb;
            color: #b45309;
            padding: 0.6rem;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .timer.warning {
            background: #fef2f2;
            color: #dc2626;
        }

        .payment-section {
            padding: 1.5rem;
        }

        .section-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 0.875rem 1rem;
            background: #fff;
            border: 1.5px solid #e5e5e5;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .payment-option:hover {
            border-color: #000;
        }

        .payment-option.selected {
            border-color: #000;
            background: #fafafa;
        }

        .payment-option img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            margin-right: 0.875rem;
        }

        .payment-option .name {
            flex: 1;
            font-weight: 500;
            font-size: 0.95rem;
            color: #111;
        }

        .payment-option .check {
            width: 20px;
            height: 20px;
            border: 1.5px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .payment-option.selected .check {
            border-color: #000;
            background: #000;
        }

        .payment-option.selected .check::after {
            content: 'âœ“';
            color: #fff;
            font-size: 0.7rem;
        }

        .pay-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-top: 1.5rem;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: opacity 0.15s;
        }

        .pay-btn:hover {
            opacity: 0.85;
        }

        .pay-btn:active {
            transform: scale(0.99);
        }

        .footer {
            padding: 1.5rem;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #888;
        }

        .footer-row {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
        }

        .footer-row span:last-child {
            color: #444;
        }

        .secure {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #aaa;
        }

        .loading {
            text-align: center;
            padding: 5rem 1.5rem;
            color: #888;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid #eee;
            border-top-color: #000;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error {
            text-align: center;
            padding: 4rem 1.5rem;
            color: #666;
        }

        .no-options {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .qr-section {
            padding: 1.5rem;
            text-align: center;
            border-top: 1px solid #eee;
        }

        .qr-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .qr-box {
            display: inline-block;
            padding: 1rem;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 0.5rem;
        }

        .qr-box canvas {
            display: block;
        }

        .qr-hint {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.75rem;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="timerBar" class="timer hidden"></div>
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <script>
        let paymentData = null;
        let countdownInterval = null;
        let selectedOption = null;

        const pathParts = window.location.pathname.split('/');
        const orderId = pathParts[pathParts.length - 1];

        async function loadPayment() {
            try {
                const response = await fetch(`/pay/api/${orderId}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Not found');
                paymentData = data;
                renderPayment(data);
                startCountdown(data.expiresAt);
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="error"><p>${error.message}</p></div>`;
            }
        }

        // Helper to parse UPI link and extract parameters
        function parseUpiLink(upiLink) {
            if (!upiLink) return null;
            try {
                // Handle both upi://pay?pa=... and just pa=...&pn=... formats
                let queryString = upiLink;
                if (upiLink.startsWith('upi://')) {
                    const urlParts = upiLink.split('?');
                    queryString = urlParts.length > 1 ? urlParts[1] : '';
                }
                const params = new URLSearchParams(queryString);
                return {
                    pa: params.get('pa'),
                    pn: params.get('pn'),
                    am: params.get('am'),
                    cu: params.get('cu') || 'INR',
                    tr: params.get('tr'),
                    tn: params.get('tn') || 'Payment'
                };
            } catch (e) {
                console.error('Error parsing UPI link:', e);
                return null;
            }
        }

        // Generate GPay deep link from UPI parameters
        function generateGpayLink(upiParams) {
            if (!upiParams || !upiParams.pa) return null;
            const { pa, pn, am, cu, tr, tn } = upiParams;
            return `gpay://upi/pay?pa=${encodeURIComponent(pa)}&pn=${encodeURIComponent(pn || 'Merchant')}&am=${am || ''}&cu=${cu}&tr=${tr || ''}&tn=${encodeURIComponent(tn)}`;
        }

        // Ensure UPI link is properly formatted
        function normalizeUpiLink(link) {
            if (!link) return null;
            // If already a full UPI link, return as-is
            if (link.startsWith('upi://')) return link;
            // If it's just query params, prepend upi://pay?
            if (link.includes('pa=')) return `upi://pay?${link}`;
            return null;
        }

        function renderPayment(data) {
            const deepLinks = data.deepLinks || {};
            const options = [];

            // Get UPI link from various sources
            let rawUpiLink = deepLinks.upi_scan || deepLinks.upi_intent || deepLinks.upi || null;
            const normalizedUpi = normalizeUpiLink(rawUpiLink);
            const upiParams = parseUpiLink(normalizedUpi);

            // Add PhonePe option
            if (deepLinks.upi_phonepe) {
                options.push({ id: 'phonepe', name: 'PhonePe', icon: '/images/phonepe.png', link: deepLinks.upi_phonepe });
            }

            // Add Paytm option
            if (deepLinks.upi_paytm || deepLinks.paytm) {
                options.push({ id: 'paytm', name: 'Paytm', icon: '/images/paytm.png', link: deepLinks.upi_paytm || deepLinks.paytm });
            }

            // Add GPay option - generate from UPI params if not provided
            if (deepLinks.upi_gpay || deepLinks.gpay) {
                options.push({ id: 'gpay', name: 'Google Pay', icon: '/images/gpay.png', link: deepLinks.upi_gpay || deepLinks.gpay });
            } else if (upiParams && upiParams.pa) {
                const gpayLink = generateGpayLink(upiParams);
                if (gpayLink) {
                    options.push({ id: 'gpay', name: 'Google Pay', icon: '/images/gpay.png', link: gpayLink });
                }
            }

            // Add generic UPI option
            if (normalizedUpi) {
                options.push({ id: 'upi', name: 'Other UPI', icon: '/images/upi.png', link: normalizedUpi });
            }

            if (options.length > 0 && !selectedOption) selectedOption = options[0].id;

            const dateStr = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
            const optionsHtml = options.length > 0
                ? options.map(o => `
                    <div class="payment-option ${selectedOption === o.id ? 'selected' : ''}" data-id="${o.id}" data-link="${o.link}" onclick="selectOption('${o.id}')">
                        <img src="${o.icon}" alt="${o.name}">
                        <span class="name">${o.name}</span>
                        <div class="check"></div>
                    </div>
                `).join('')
                : '<div class="no-options">No payment options</div>';

            const selectedLink = options.find(o => o.id === selectedOption)?.link || '#';

            document.getElementById('content').innerHTML = `
                <div class="amount-section">
                    <div class="amount">â‚¹${data.amount.toLocaleString('en-IN')}</div>
                    <div class="amount-label">Amount to pay</div>
                </div>
                <div class="payment-section">
                    <div class="section-label">Pay with</div>
                    <div class="payment-options">${optionsHtml}</div>
                    <a href="${selectedLink}" class="pay-btn" id="payBtn" ${options.length === 0 ? 'style="pointer-events:none;opacity:0.4"' : ''}>
                        Pay â‚¹${data.amount.toLocaleString('en-IN')}
                    </a>
                </div>
                <div class="qr-section" id="qrSection">
                    <div class="section-label">Or scan QR code</div>
                    <div class="qr-box">
                        <div id="qrCode"></div>
                    </div>
                    <div class="qr-hint">Scan with any UPI app</div>
                </div>
                <div class="footer">
                    <div class="footer-row"><span>Order</span><span>${(data.merchantOrderId || data.orderId).substring(0, 16)}...</span></div>
                    <div class="footer-row"><span>Date</span><span>${dateStr}</span></div>
                    <div class="secure">ðŸ”’ Secured payment</div>
                </div>
            `;

            // Generate QR code from normalized UPI link
            if (normalizedUpi) {
                setTimeout(() => {
                    const qrContainer = document.getElementById('qrCode');
                    if (qrContainer && typeof QRCode !== 'undefined') {
                        try {
                            // Clear any existing QR code
                            qrContainer.innerHTML = '';
                            // Create new QR code using qrcodejs library
                            new QRCode(qrContainer, {
                                text: normalizedUpi,
                                width: 180,
                                height: 180,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.M
                            });
                        } catch (err) {
                            console.error('QR Error:', err);
                            const qrSection = document.getElementById('qrSection');
                            if (qrSection) qrSection.style.display = 'none';
                        }
                    } else {
                        console.error('QRCode library not loaded');
                        const qrSection = document.getElementById('qrSection');
                        if (qrSection) qrSection.style.display = 'none';
                    }
                }, 100);
            } else {
                const qrSection = document.getElementById('qrSection');
                if (qrSection) qrSection.style.display = 'none';
            }
        }

        function selectOption(id) {
            selectedOption = id;
            document.querySelectorAll('.payment-option').forEach(el => el.classList.toggle('selected', el.dataset.id === id));
            const el = document.querySelector(`.payment-option[data-id="${id}"]`);
            if (el) document.getElementById('payBtn').href = el.dataset.link;
        }

        function startCountdown(expiresAt) {
            if (!expiresAt) return;
            const timerBar = document.getElementById('timerBar');
            timerBar.classList.remove('hidden');
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const remaining = expiresAt - Date.now();
                if (remaining <= 0) {
                    timerBar.textContent = 'Expired';
                    timerBar.classList.add('warning');
                    clearInterval(countdownInterval);
                    return;
                }
                const m = Math.floor(remaining / 60000);
                const s = Math.floor((remaining % 60000) / 1000);
                timerBar.textContent = `${m}:${s.toString().padStart(2, '0')} remaining`;
                if (remaining < 300000) timerBar.classList.add('warning');
            }, 1000);
        }

        async function checkStatus() {
            try {
                const res = await fetch(`/pay/api/${orderId}`);
                const data = await res.json();
                if (data.status === 'success') {
                    clearInterval(countdownInterval);
                    Toastify({ text: 'Payment successful!', duration: 3000, gravity: "top", position: "center", style: { background: "#000", borderRadius: "8px" } }).showToast();
                    if (paymentData.skipUrl) setTimeout(() => window.location.href = paymentData.skipUrl, 2000);
                }
            } catch (e) { }
        }

        loadPayment();
        setInterval(checkStatus, 5000);
    </script>
</body>

</html>