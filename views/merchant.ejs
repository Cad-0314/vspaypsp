<!DOCTYPE html>
<html lang="<%= currentLang %>">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Dashboard - Payable</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root {
            --primary: #1890ff;
            --primary-dark: #096dd9;
            --primary-light: #e6f7ff;
            --bg-light: #f5f7fa;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --success: #52c41a;
            --danger: #ff4d4f;
            --warning: #faad14;
            --border: #e8e8e8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        body {
            background: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* Top Navigation */
        .top-nav {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
            display: flex;
            align-items: center;
            height: 56px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 2rem;
            text-decoration: none;
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .nav-logo img {
            height: 32px;
            width: auto;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex: 1;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-item:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-item.active {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lang-switch {
            display: flex;
            gap: 0.25rem;
        }

        .lang-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-dark);
        }

        .lang-btn:hover,
        .lang-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .user-dropdown {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .user-dropdown:hover {
            background: #f5f5f5;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
        }

        /* Main Content */
        .main-content {
            padding: 1.5rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Stats Section */
        .stats-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .stats-tab {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
        }

        .stats-tab.secondary {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--border);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 1.5rem;
        }

        .content-main {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .card-body {
            padding: 1.25rem;
        }

        /* Quick Actions Sidebar */
        .sidebar-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .quick-actions {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }

        .quick-actions h3 {
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-bottom: 0.75rem;
        }

        .quick-actions-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .quick-link {
            display: block;
            color: var(--primary);
            font-size: 0.875rem;
            text-decoration: none;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .quick-link:hover {
            text-decoration: underline;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        th {
            background: #fafafa;
            font-weight: 600;
            color: var(--text-muted);
        }

        tr:hover {
            background: #fafafa;
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background: #f6ffed;
            color: #52c41a;
        }

        .badge-pending {
            background: #fffbe6;
            color: #faad14;
        }

        .badge-failed {
            background: #fff2f0;
            color: #ff4d4f;
        }

        /* Filter Badges */
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: #1890ff;
            color: white;
        }

        .filter-tab.green {
            background: #52c41a;
        }

        .filter-tab.orange {
            background: #fa8c16;
        }

        .filter-tab.yellow {
            background: #fadb14;
            color: #333;
        }

        .filter-tab.red {
            background: #ff4d4f;
        }

        .filter-tab.outline {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-dark);
        }

        /* Forms */
        .form-control {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.875rem;
            transition: border 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .btn {
            padding: 0.625rem 1rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: white;
            border-color: var(--border);
            color: var(--text-dark);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Chart Container */
        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Date Selector */
        .date-selector {
            display: flex;
            gap: 0.5rem;
        }

        .date-selector select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Blur Text */
        .blur-text {
            filter: blur(5px);
            cursor: pointer;
            transition: filter 0.3s;
        }

        .blur-text:hover {
            filter: none;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .sidebar-panel {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .top-nav {
                padding: 0 1rem;
            }

            .nav-menu {
                display: none;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            width: 90%;
            max-width: 450px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <!-- Top Navigation -->
    <header class="top-nav">
        <a href="/" class="nav-logo">
            <img src="/images/logo.png" alt="Payable">

        </a>

        <nav class="nav-menu">
            <div class="nav-item active" onclick="switchTab('dashboard')">
                <i class="ri-home-4-line"></i>
                <%= t('nav_dashboard') %>
            </div>
            <div class="nav-item" onclick="switchTab('profile')">
                <i class="ri-link-m"></i>
                <%= t('nav_profile') %>
            </div>
            <div class="nav-item" onclick="switchTab('settlements')">
                <i class="ri-bank-card-line"></i>
                <%= t('nav_settlements') %>
            </div>
            <div class="nav-item" onclick="switchTab('payin')">
                <i class="ri-arrow-left-down-line"></i>
                <%= t('nav_payin') %>
            </div>
            <div class="nav-item" onclick="switchTab('payout')">
                <i class="ri-arrow-right-up-line"></i>
                <%= t('nav_payout') %>
            </div>
            <div class="nav-item" onclick="switchTab('paylink')">
                <i class="ri-links-line"></i>
                <%= t('nav_paylink') %>
            </div>
        </nav>

        <div class="nav-right">
            <span
                style="background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-right: 0.5rem;"
                title="Build: Jan 11, 2026">v2.1</span>
            <div class="lang-switch">
                <a href="?lang=en" class="lang-btn <%= currentLang === 'en' ? 'active' : '' %>">EN</a>
                <a href="?lang=zh" class="lang-btn <%= currentLang === 'zh' ? 'active' : '' %>">中文</a>
            </div>
            <div class="user-dropdown">
                <div class="user-avatar">
                    <%= user.username.charAt(0).toUpperCase() %>
                </div>
                <span style="font-size: 0.875rem;">
                    <%= user.username %>
                </span>
                <i class="ri-arrow-down-s-line"></i>
            </div>
            <a href="/auth/logout" class="btn btn-outline" style="padding: 0.375rem 0.75rem;">
                <i class="ri-logout-box-r-line"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-tabs">
                <button class="stats-tab">
                    <%= t('today_trading') || 'Today Trading' %>
                </button>
                <button class="stats-tab secondary">
                    <%= t('yesterday_trading') || 'Yesterday Trading' %>
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="ri-shield-check-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-label">
                            <%= t('today_volume') %> (INR)
                        </div>
                        <div class="stat-value" id="stat-today-vol">0.00</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="ri-shield-check-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-label">
                            <%= t('payin_count') || 'Pay-In Count' %>
                        </div>
                        <div class="stat-value" id="stat-today-count">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="ri-shield-check-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-label">
                            <%= t('payout_count') || 'Pay-Out Count' %>
                        </div>
                        <div class="stat-value" id="stat-payout-count">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="ri-shield-check-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-label">
                            <%= t('avail_balance') %> (INR)
                        </div>
                        <div class="stat-value" style="color: var(--primary);" id="stat-balance">
                            <%= parseFloat(user.balance).toFixed(2) %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-grid">
                <div class="content-main">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <%= t('volume_trends') || 'Recent Transactions' %>
                            </div>
                            <div class="date-selector">
                                <select id="chart-range">
                                    <option value="7">
                                        <%= t('last_7_days') || 'Last 7 Days' %>
                                    </option>
                                    <option value="30">
                                        <%= t('last_30_days') || 'Last 30 Days' %>
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="volumeChart"></canvas>
                            </div>
                        </div>
                    </div>


                </div>

                <div class="sidebar-panel">
                    <div class="quick-actions">
                        <h3>
                            <%= user.username %>
                        </h3>
                        <div class="quick-actions-title">
                            <%= t('quick_actions') || 'Quick Actions' %>
                        </div>
                        <a class="quick-link" onclick="switchTab('profile')">
                            <%= t('change_password') || 'Change Password' %>
                        </a>
                        <a class="quick-link" onclick="switchTab('profile')">
                            <%= t('api_settings') || 'API Settings' %>
                        </a>
                        <a class="quick-link" onclick="switchTab('profile')">
                            <%= t('ip_whitelist') || 'IP Whitelist' %>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payin Tab -->
        <div id="tab-payin" class="tab-content">
            <h2 style="margin-bottom: 1rem;">
                <%= t('payin_history') %>
            </h2>

            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-body" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="payin-filter-search" class="form-control"
                        placeholder="<%= t('search_order') || 'Search Order ID...' %>" style="max-width: 250px;">
                    <input type="date" id="payin-filter-start" class="form-control" style="width: auto;">
                    <input type="date" id="payin-filter-end" class="form-control" style="width: auto;">
                    <select id="payin-filter-status" class="form-control" style="width: auto;">
                        <option value="">
                            <%= t('all_status') || 'All Status' %>
                        </option>
                        <option value="success">
                            <%= t('success') || 'Success' %>
                        </option>
                        <option value="pending">
                            <%= t('pending') || 'Pending' %>
                        </option>
                        <option value="failed">
                            <%= t('failed') || 'Failed' %>
                        </option>
                    </select>
                    <button class="btn btn-primary" onclick="loadPayinHistory()"><i class="ri-search-line"></i>
                        <%= t('search') || 'Search' %>
                    </button>
                    <button class="btn btn-outline" onclick="exportOrders('payin')"><i class="ri-download-2-line"></i>
                        <%= t('export') || 'Export' %>
                    </button>
                </div>
            </div>

            <div class="card">
                <table id="payin-table">
                    <thead>
                        <tr>
                            <th>
                                <%= t('order_id') || 'Order ID' %>
                            </th>
                            <th>
                                <%= t('amount') || 'Amount' %>
                            </th>
                            <th>
                                <%= t('status') || 'Status' %>
                            </th>
                            <th>
                                <%= t('created') || 'Created' %>
                            </th>
                            <th>
                                <%= t('updated') || 'Updated' %>
                            </th>
                            <th>
                                <%= t('actions') || 'Actions' %>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="empty-state"><i class="ri-inbox-line"></i><br>Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="payin-pagination" style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
            </div>
        </div>

        <!-- Payout Tab -->
        <div id="tab-payout" class="tab-content">
            <h2 style="margin-bottom: 1rem;">
                <%= t('payout_history') %>
            </h2>

            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-body" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="payout-filter-search" class="form-control"
                        placeholder="<%= t('search_order') || 'Search Order ID...' %>" style="max-width: 250px;">
                    <input type="date" id="payout-filter-start" class="form-control" style="width: auto;">
                    <input type="date" id="payout-filter-end" class="form-control" style="width: auto;">
                    <select id="payout-filter-status" class="form-control" style="width: auto;">
                        <option value="">
                            <%= t('all_status') || 'All Status' %>
                        </option>
                        <option value="success">
                            <%= t('success') || 'Success' %>
                        </option>
                        <option value="pending">
                            <%= t('pending') || 'Pending' %>
                        </option>
                        <option value="failed">
                            <%= t('failed') || 'Failed' %>
                        </option>
                    </select>
                    <button class="btn btn-primary" onclick="loadPayoutHistory()"><i class="ri-search-line"></i>
                        <%= t('search') || 'Search' %>
                    </button>
                    <button class="btn btn-outline" onclick="exportOrders('payout')"><i class="ri-download-2-line"></i>
                        <%= t('export') || 'Export' %>
                    </button>
                </div>
            </div>

            <div class="card">
                <table id="payout-table">
                    <thead>
                        <tr>
                            <th>
                                <%= t('order_id') || 'Order ID' %>
                            </th>
                            <th>
                                <%= t('amount') || 'Amount' %>
                            </th>
                            <th>
                                <%= t('status') || 'Status' %>
                            </th>
                            <th>
                                <%= t('created') || 'Created' %>
                            </th>
                            <th>
                                <%= t('updated') || 'Updated' %>
                            </th>
                            <th>
                                <%= t('actions') || 'Actions' %>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="empty-state"><i class="ri-inbox-line"></i><br>Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="payout-pagination"
                style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;"></div>
        </div>

        <!-- Settlements Tab -->
        <div id="tab-settlements" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>
                    <%= t('settlements') %>
                </h2>
                <button class="btn btn-primary" onclick="openSettlementModal()">
                    <i class="ri-add-line"></i>
                    <%= t('request_settlement') %>
                </button>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-body">
                    <form id="settle-form" onsubmit="requestSettlement(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label class="stat-label">
                                    <%= t('settlement_amount') || 'Settlement Amount' %> (₹)
                                </label>
                                <input type="number" id="s-amount" class="form-control" required min="100">
                            </div>
                            <div>
                                <label class="stat-label">
                                    <%= t('settlement_type') || 'Settlement Type' %>
                                </label>
                                <select id="s-type" class="form-control">
                                    <option value="usdt">USDT (TRC20)</option>
                                </select>
                            </div>
                        </div>
                        <label class="stat-label">
                            <%= t('usdt_address') || 'USDT Address / Notes' %>
                        </label>
                        <textarea id="s-notes" class="form-control" rows="2"
                            placeholder="Enter your TRC20 wallet address..."></textarea>
                        <button type="submit" class="btn btn-primary"
                            style="width: 100%; margin-top: 1rem; justify-content: center;">
                            <%= t('btn_request_settlement') %>
                        </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <table id="settlement-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>
                                <%= t('amount') || 'Amount' %>
                            </th>
                            <th>
                                <%= t('status') || 'Status' %>
                            </th>
                            <th>
                                <%= t('details') || 'Details' %>
                            </th>
                            <th>
                                <%= t('created') || 'Created' %>
                            </th>
                            <th>
                                <%= t('updated') || 'Updated' %>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="empty-state"><i class="ri-inbox-line"></i><br>Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="settlements-pagination"
                style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;"></div>
        </div>

        <!-- PayLink Tab -->
        <div id="tab-paylink" class="tab-content">
            <h2 style="margin-bottom: 1rem;">
                <%= t('payment_link') %>
            </h2>

            <div class="card" style="max-width: 500px;">
                <div class="card-header">
                    <div class="card-title"><i class="ri-link-m"></i>
                        <%= t('create_new_link') %>
                    </div>
                </div>
                <div class="card-body">
                    <form onsubmit="generatePayLink(event)">
                        <label class="stat-label">
                            <%= t('amount') %>
                        </label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <span
                                style="padding: 0.625rem 1rem; background: #f5f5f5; border: 1px solid var(--border); border-radius: 4px 0 0 4px;">₹</span>
                            <input type="number" id="link-amount" class="form-control"
                                style="border-radius: 0 4px 4px 0;" required min="10" placeholder="0.00">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                            <%= t('generate_link') %> <i class="ri-arrow-right-line"></i>
                        </button>
                    </form>

                    <div id="paylink-result"
                        style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f6ffed; border: 1px solid #b7eb8f; border-radius: 4px;">
                        <label
                            style="font-size: 0.75rem; color: #52c41a; font-weight: 600; margin-bottom: 0.5rem; display: block;">Ready
                            to Share</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="generated-link" class="form-control" readonly
                                style="background: white;">
                            <button class="btn btn-primary" onclick="copyLink()"><i
                                    class="ri-file-copy-line"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="tab-profile" class="tab-content">
            <h2 style="margin-bottom: 1rem;">
                <%= t('profile_settings') %>
            </h2>

            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <div class="card-title"><i class="ri-key-2-line"></i> API Credentials</div>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <label class="stat-label">Merchant ID (x-merchant-id)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-control" value="<%= user.apiKey %>" readonly
                                style="font-family: monospace; background: #f5f5f5;">
                            <button class="btn btn-outline"
                                onclick="navigator.clipboard.writeText('<%= user.apiKey %>'); showToast('Copied!')"><i
                                    class="ri-file-copy-line"></i></button>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label class="stat-label">API Secret</label>
                        <div class="blur-text form-control" style="font-family: monospace; background: #f5f5f5;"
                            onclick="this.classList.remove('blur-text')">
                            <%= user.apiSecret %>
                        </div>
                        <small style="color: var(--text-muted);">Click to reveal. Never share this key.</small>
                    </div>
                    <div
                        style="padding: 1rem; background: var(--primary-light); border-radius: 4px; display: flex; gap: 0.75rem; align-items: center;">
                        <i class="ri-information-fill" style="color: var(--primary); font-size: 1.25rem;"></i>
                        <span style="font-size: 0.875rem;">Check our <a href="/docs" style="color: var(--primary);">API
                                Documentation</a> for integration guide.</span>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <div class="card-title"><i class="ri-shield-keyhole-line"></i> IP Whitelist / IP白名单</div>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                        Only these IPs can make API calls. Leave empty to allow all IPs.<br>
                        只有这些IP可以调用API。留空则允许所有IP。
                    </p>
                    <div id="ip-list" style="margin-bottom: 1rem;">Loading...</div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="new-ip-input" class="form-control" placeholder="192.168.1.1"
                            style="max-width: 200px;">
                        <button class="btn btn-primary" onclick="showAddIpModal()"><i class="ri-add-line"></i> Add
                            IP</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="ri-percent-line"></i> Active Rates</div>
                </div>
                <div class="card-body">
                    <% let rates={}; try { rates=JSON.parse(user.channel_rates || '{}' ); } catch(e) {} %>
                        <div
                            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                            <div style="padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                                <div class="stat-label">Payin Fee</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary);">
                                    <%= rates.payinRate || 5 %>%
                                </div>
                            </div>
                            <div style="padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                                <div class="stat-label">Payout Fee</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: var(--danger);">
                                    <%= rates.payoutRate || 3 %>%
                                </div>
                            </div>
                            <div style="padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                                <div class="stat-label">Fixed Fee</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">₹<%= rates.payoutFixedFee || 6 %>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1rem; border-color: var(--primary); background: var(--primary-light);">
                <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                    <i class="ri-customer-service-2-line" style="font-size: 2rem; color: var(--primary);"></i>
                    <div>
                        <h3 style="margin-bottom: 0.25rem;">
                            <%= t('need_help') || 'Need Assistance?' %>
                        </h3>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.75rem;">Contact our
                            support team for any issues.</p>
                        <a href="https://t.me/payable_support" target="_blank" class="btn btn-primary"
                            style="padding: 0.375rem 0.75rem;">
                            <i class="ri-telegram-fill"></i> Contact Support
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- IP Modal -->
    <div id="ip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="ip-modal-title">IP Action</div>
                <i class="ri-close-line modal-close" onclick="closeIpModal()"></i>
            </div>
            <p id="ip-modal-desc" style="color: var(--text-muted); margin-bottom: 1rem;">Confirm action</p>
            <div style="margin-bottom: 1rem;">
                <label class="stat-label">2FA Code / 2FA验证码</label>
                <input type="text" id="totp-input" class="form-control" placeholder="123456" maxlength="6"
                    style="font-size: 1.25rem; text-align: center; letter-spacing: 0.5rem;">
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-outline" style="flex: 1;" onclick="closeIpModal()">Cancel</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="confirmIpAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Settlement Modal -->
    <div id="settleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Request Settlement</div>
                <i class="ri-close-line modal-close"
                    onclick="document.getElementById('settleModal').classList.remove('active')"></i>
            </div>
            <form onsubmit="submitSettlement(event)">
                <div style="margin-bottom: 1rem;">
                    <label class="stat-label">Amount (₹)</label>
                    <input type="number" id="settle-amount" class="form-control" required min="100"
                        max="<%= user.balance %>">
                    <small style="color: var(--text-muted);">Available Balance: ₹<%= parseFloat(user.balance).toFixed(2)
                            %></small>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="stat-label">USDT Address / Notes</label>
                    <textarea id="settle-notes" class="form-control" rows="2"
                        placeholder="Enter your TRC20 wallet address..."></textarea>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" class="btn btn-outline" style="flex: 1;"
                        onclick="document.getElementById('settleModal').classList.remove('active')">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Pagination Helper
        function renderPagination(paging, containerId, clickActionTemplate) {
            const container = document.getElementById(containerId);
            if (!paging || paging.pages <= 1) { container.innerHTML = ''; return; }

            const prevAction = clickActionTemplate.replace('{page}', paging.page - 1);
            const nextAction = clickActionTemplate.replace('{page}', paging.page + 1);

            container.innerHTML = `
                <span style="font-size: 0.875rem; color: grey; margin-right: auto;">Page ${paging.page} of ${paging.pages} (${paging.total} items)</span>
                <button class="btn btn-outline" style="padding: 0.25rem 0.5rem;" onclick="${prevAction}" ${paging.page <= 1 ? 'disabled' : ''}><i class="ri-arrow-left-s-line"></i></button>
                <button class="btn btn-outline" style="padding: 0.25rem 0.5rem;" onclick="${nextAction}" ${paging.page >= paging.pages ? 'disabled' : ''}><i class="ri-arrow-right-s-line"></i></button>
            `;
        }

        switchTab('dashboard');
        loadStats();

        let chartInstance = null;
        let successChartInstance = null;

        function showToast(text, type = 'success') {
            Toastify({
                text: text,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                stopOnFocus: true,
                style: {
                    background: type === 'success' ? "#52c41a" : "#ff4d4f",
                    borderRadius: "4px"
                }
            }).showToast();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');

            if (tab === 'payin') loadOrders('payin');
            if (tab === 'payout') loadOrders('payout');
            if (tab === 'settlements') loadSettlements();
            if (tab === 'profile') loadIps();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/merchant/stats');
                const data = await res.json();
                if (data.success) {
                    const s = data.stats;
                    document.getElementById('stat-today-vol').innerText = s.today.payin.toFixed(2);
                    document.getElementById('stat-today-count').innerText = s.today.payinSuccessCount;
                    document.getElementById('stat-payout-count').innerText = s.today.payoutSuccessCount || 0;
                    renderSuccessChart(s.today.payinSuccessCount, s.today.payinFailedCount + s.today.payinPendingCount);
                }
                loadChart();
            } catch (e) { console.error(e); }
        }

        function renderSuccessChart(success, failed) {
            const ctx = document.getElementById('successRateChart').getContext('2d');
            if (successChartInstance) successChartInstance.destroy();

            const total = success + failed;
            const rate = total > 0 ? ((success / total) * 100).toFixed(1) : 0;

            successChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Other'],
                    datasets: [{
                        data: [success, failed || 1],
                        backgroundColor: ['#52c41a', '#f0f0f0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false } }
                },
                plugins: [{
                    id: 'text',
                    beforeDraw: function (chart) {
                        var width = chart.width, height = chart.height, ctx = chart.ctx;
                        ctx.restore();
                        var fontSize = (height / 114).toFixed(2);
                        ctx.font = fontSize + "em sans-serif";
                        ctx.textBaseline = "middle";
                        var text = rate + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });
        }

        async function loadChart() {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            const res = await fetch('/api/merchant/chart');
            const data = await res.json();

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Payin', data: data.payinData, backgroundColor: 'rgba(24, 144, 255, 0.8)' },
                        { label: 'Payout', data: data.payoutData, backgroundColor: 'rgba(255, 77, 79, 0.8)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function loadOrders(type, page = 1) {
            const tbody = document.getElementById(type + '-table').querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="ri-loader-4-line ri-spin"></i><br>Loading...</td></tr>';

            const start = document.getElementById(type + '-filter-start').value;
            const end = document.getElementById(type + '-filter-end').value;
            const status = document.getElementById(type + '-filter-status').value;
            const search = document.getElementById(type + '-filter-search').value;

            let url = `/api/merchant/orders?type=${type}&page=${page}`;
            if (start) url += `&startDate=${start}`;
            if (end) url += `&endDate=${end}`;
            if (status) url += `&status=${status}`;
            if (search) url += `&search=${search}`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.success && data.orders.length > 0) {
                    tbody.innerHTML = data.orders.map(o => `
                        <tr>
                            <td style="font-family: monospace; font-weight: 500;">${o.orderId}</td>
                            <td>₹${o.amount}</td>
                            <td><span class="badge badge-${o.status}">${o.status}</span></td>
                            <td>${new Date(o.createdAt).toLocaleString()}</td>
                            <td>${new Date(o.updatedAt).toLocaleString()}</td>
                            <td>
                                <button class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="resendCallback('${o.orderId}')">
                                    <i class="ri-refresh-line"></i> Callback
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    renderPagination(data.pagination, type + '-pagination', `loadOrders('${type}', {page})`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="ri-inbox-line"></i><br>No transactions found</td></tr>';
                    document.getElementById(type + '-pagination').innerHTML = '';
                }
            } catch (e) { console.error(e); }
        }

        function exportOrders(type) {
            const start = document.getElementById(type + '-filter-start').value;
            const end = document.getElementById(type + '-filter-end').value;
            const status = document.getElementById(type + '-filter-status').value;
            let url = `/api/merchant/export/orders?type=${type}`;
            if (start) url += `&startDate=${start}`;
            if (end) url += `&endDate=${end}`;
            if (status) url += `&status=${status}`;
            window.location.href = url;
        }

        function loadPayinHistory(page) { loadOrders('payin', page); }
        function loadPayoutHistory(page) { loadOrders('payout', page); }

        async function loadSettlements(page = 1) {
            const tbody = document.getElementById('settlement-table').querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="ri-loader-4-line ri-spin"></i><br>Loading...</td></tr>';

            try {
                const res = await fetch(`/api/merchant/settlements?page=${page}`);
                const data = await res.json();

                if (data.success && data.settlements.length > 0) {
                    tbody.innerHTML = data.settlements.map(s => `
                        <tr>
                            <td style="font-family: monospace;">${s.id}</td>
                            <td style="font-weight: 600;">₹${s.amount}</td>
                            <td><span class="badge badge-${s.status}">${s.status}</span></td>
                            <td>
                                ${s.utr ? `<small style="color: var(--text-muted);">UTR: ${s.utr}</small><br>` : ''}
                                ${s.notes ? `<small>${s.notes}</small>` : ''}
                            </td>
                            <td>${new Date(s.createdAt).toLocaleString()}</td>
                            <td>${new Date(s.updatedAt).toLocaleString()}</td>
                        </tr>
                    `).join('');
                    renderPagination(data.pagination, 'settlements-pagination', `loadSettlements({page})`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="ri-inbox-line"></i><br>No settlements yet</td></tr>';
                    document.getElementById('settlements-pagination').innerHTML = '';
                }
            } catch (e) { console.error(e); }
        }

        function openSettlementModal() {
            document.getElementById('settleModal').classList.add('active');
        }

        async function requestSettlement(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Processing...';
            btn.disabled = true;

            const amount = document.getElementById('s-amount').value;
            const notes = document.getElementById('s-notes').value;
            const type = document.getElementById('s-type').value;

            try {
                const res = await fetch('/api/merchant/settlements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, notes, type })
                });
                const data = await res.json();
                if (data.success) {
                    e.target.reset();
                    loadSettlements();
                    const currentBal = parseFloat(document.getElementById('stat-balance').innerText);
                    document.getElementById('stat-balance').innerText = (currentBal - parseFloat(amount)).toFixed(2);
                    showToast('Settlement request submitted successfully');
                } else {
                    showToast(data.error, 'error');
                }
            } catch (e) { showToast('Error submitting request', 'error'); }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function submitSettlement(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Processing...';
            btn.disabled = true;

            const amount = document.getElementById('settle-amount').value;
            const notes = document.getElementById('settle-notes').value;

            try {
                const res = await fetch('/api/merchant/settlements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, notes, type: 'usdt' })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('settleModal').classList.remove('active');
                    loadSettlements();
                    const currentBal = parseFloat(document.getElementById('stat-balance').innerText);
                    document.getElementById('stat-balance').innerText = (currentBal - parseFloat(amount)).toFixed(2);
                    showToast('Settlement request submitted');
                } else {
                    showToast(data.error, 'error');
                }
            } catch (e) { showToast('Error submitting request', 'error'); }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function generatePayLink(e) {
            e.preventDefault();
            const amount = document.getElementById('link-amount').value;
            const res = await fetch('/api/merchant/paylink', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('generated-link').value = data.link;
                document.getElementById('paylink-result').style.display = 'block';
            }
        }

        function copyLink() {
            const el = document.getElementById('generated-link');
            el.select();
            document.execCommand('copy');
            showToast('Copied to clipboard!');
        }

        async function resendCallback(orderId) {
            if (!confirm('Resend callback for this order?')) return;
            try {
                const res = await fetch(`/api/merchant/callback/${orderId}`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    const status = data.isOk ? 'Merchant OK' : 'Merchant Error';
                    showToast(`Callback Sent: ${status} (HTTP ${data.httpCode})`, data.isOk ? 'success' : 'warning');
                } else {
                    showToast(data.message || 'Callback failed', 'error');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // IP Whitelist Management
        let currentIps = [];
        let pendingIpAction = null;

        async function loadIps() {
            try {
                const res = await fetch('/api/merchant/ips');
                const data = await res.json();
                if (data.success) {
                    currentIps = data.ips;
                    renderIpList(data.ips);
                }
            } catch (e) {
                document.getElementById('ip-list').innerHTML = '<div style="color: #ff4d4f;">Failed to load IPs</div>';
            }
        }

        function renderIpList(ips) {
            const container = document.getElementById('ip-list');
            if (ips.length === 0) {
                container.innerHTML = `
                    <div style="padding: 1rem; background: #f5f5f5; border-radius: 4px; color: var(--text-muted); text-align: center;">
                        <i class="ri-global-line" style="font-size: 1.5rem;"></i><br>
                        No IPs whitelisted - all IPs allowed
                    </div>`;
                return;
            }
            container.innerHTML = ips.map(ip => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; margin-bottom: 0.5rem;">
                    <span style="font-family: monospace;">${ip}</span>
                    <button class="btn" style="background: #fff2f0; color: #ff4d4f; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="showRemoveIpModal('${ip}')">
                        <i class="ri-delete-bin-line"></i> Remove
                    </button>
                </div>
            `).join('');
        }

        function showAddIpModal() {
            const ip = document.getElementById('new-ip-input').value.trim();
            if (!ip) { showToast('Please enter an IP address', 'error'); return; }
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipRegex.test(ip)) { showToast('Invalid IP format', 'error'); return; }
            pendingIpAction = { action: 'add', ip: ip };
            document.getElementById('ip-modal-title').innerText = 'Add IP / 添加IP';
            document.getElementById('ip-modal-desc').innerText = `Add ${ip} to whitelist`;
            document.getElementById('totp-input').value = '';
            document.getElementById('ip-modal').classList.add('active');
        }

        function showRemoveIpModal(ip) {
            pendingIpAction = { action: 'remove', ip: ip };
            document.getElementById('ip-modal-title').innerText = 'Remove IP / 删除IP';
            document.getElementById('ip-modal-desc').innerText = `Remove ${ip} from whitelist`;
            document.getElementById('totp-input').value = '';
            document.getElementById('ip-modal').classList.add('active');
        }

        function closeIpModal() {
            document.getElementById('ip-modal').classList.remove('active');
            pendingIpAction = null;
        }

        async function confirmIpAction() {
            if (!pendingIpAction) return;
            const totpCode = document.getElementById('totp-input').value.trim();
            if (!totpCode || totpCode.length !== 6) { showToast('Please enter 6-digit 2FA code', 'error'); return; }

            const endpoint = pendingIpAction.action === 'add' ? '/api/merchant/ips/add' : '/api/merchant/ips/remove';
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: pendingIpAction.ip, totpCode: totpCode })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    currentIps = data.ips;
                    renderIpList(data.ips);
                    document.getElementById('new-ip-input').value = '';
                    closeIpModal();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
    </script>
</body>

</html>