<!DOCTYPE html>
<html lang="<%= currentLang %>">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Dashboard - VSPAY</title>
    <!-- Fonts & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --bg-dark: #111827;
            --bg-light: #F3F4F6;
            --text-dark: #1F2937;
            --text-light: #9CA3AF;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--bg-light);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-dark);
            color: white;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            z-index: 50;
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .nav-links {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.875rem 1rem;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
        }

        .user-profile {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Top Header (Mobile mainly) */
        .top-header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            display: none;
            /* Desktop default hidden */
        }

        .mobile-toggle {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dark);
        }

        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Components */
        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #6B7280;
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #E5E7EB;
            position: relative;
            overflow: hidden;
        }

        .stat-icon {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 3rem;
            opacity: 0.1;
            color: var(--primary);
            transform: rotate(-10deg);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6B7280;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }

        .stat-sub {
            font-size: 0.75rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #E5E7EB;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #F3F4F6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #F3F4F6;
            font-size: 0.875rem;
        }

        th {
            background: #F9FAFB;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: #F9FAFB;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .badge-success {
            background: #ECFDF5;
            color: #059669;
        }

        .badge-pending {
            background: #FFFBEB;
            color: #D97706;
        }

        .badge-failed {
            background: #FEF2F2;
            color: #DC2626;
        }

        /* Forms & Buttons */
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border 0.2s;
            background: #F9FAFB;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .blur-text {
            filter: blur(6px);
            transition: 0.3s;
            cursor: pointer;
            user-select: none;
        }

        .blur-text:hover {
            filter: blur(0);
        }

        /* Tabs */
        .tab-content {
            display: none;
            animation: slideIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                height: 100%;
                transform: translateX(-100%);
                width: 280px;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .top-header {
                display: flex;
            }

            .main-content {
                margin-left: 0;
            }

            .overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }

            .overlay.active {
                display: block;
            }
        }
    </style>
</head>

<body>
    <div class="overlay" onclick="toggleSidebar()"></div>
    <div class="dashboard-container">

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="/images/logo.png" alt="VSPAY" style="height: 40px; width:auto; border-radius:8px;">
                <span class="logo-text">VSPAY <span style="font-weight:300; opacity:0.7">MERCHANT</span></span>
            </div>

            <nav class="nav-links">
                <div class="nav-item active" onclick="switchTab('dashboard')">
                    <i class="ri-dashboard-3-line"></i>
                    <%= t('nav_dashboard') %>
                </div>
                <div class="nav-item" onclick="switchTab('payin')">
                    <i class="ri-arrow-left-down-line"></i>
                    <%= t('nav_payin') %>
                </div>
                <div class="nav-item" onclick="switchTab('payout')">
                    <i class="ri-arrow-right-up-line"></i>
                    <%= t('nav_payout') %>
                </div>
                <div class="nav-item" onclick="switchTab('settlements')">
                    <i class="ri-bank-card-line"></i>
                    <%= t('nav_settlements') %>
                </div>
                <div class="nav-item" onclick="switchTab('paylink')">
                    <i class="ri-link-m"></i>
                    <%= t('nav_paylink') %>
                </div>
                <div class="nav-item" onclick="switchTab('profile')">
                    <i class="ri-user-settings-line"></i>
                    <%= t('nav_profile') %>
                </div>
            </nav>

            <div class="user-profile">
                <div class="user-info">
                    <div class="user-avatar">
                        <%= user.username.charAt(0).toUpperCase() %>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:0.875rem; font-weight:600;">
                            <%= user.username %>
                        </div>
                        <div style="font-size:0.75rem; color:var(--text-light);">Merchant Account</div>
                    </div>
                </div>
                <a href="/auth/logout" class="btn"
                    style="width:100%; justify-content:center; background:rgba(239, 68, 68, 0.2); color:#FCA5A5; padding:0.5rem;">
                    <i class="ri-logout-box-r-line"></i>
                    <%= t('btn_logout') %>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <div class="mobile-toggle" onclick="toggleSidebar()"><i class="ri-menu-2-fill"></i></div>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <a href="?lang=en" class="badge"
                        style="background:#f3f4f6; color:inherit; text-decoration:none;">ðŸ‡¬ðŸ‡§ EN</a>
                    <a href="?lang=zh" class="badge"
                        style="background:#f3f4f6; color:inherit; text-decoration:none;">ðŸ‡¨ðŸ‡³ CN</a>
                </div>
            </header>

            <div class="content-scroll">

                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content active">
                    <h1>
                        <%= t('dashboard_overview') %>
                    </h1>
                    <div class="subtitle">Welcome back, here's what's happening today.</div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="ri-wallet-3-line stat-icon"></i>
                            <div class="stat-label">
                                <%= t('avail_balance') %>
                            </div>
                            <div class="stat-value" style="color:var(--success);">
                                <span>â‚¹</span><span id="stat-balance">
                                    <%= parseFloat(user.balance).toFixed(2) %>
                                </span>
                            </div>
                            <div class="stat-sub"><i class="ri-arrow-up-circle-fill"></i> Live Balance</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-bar-chart-groupped-line stat-icon"></i>
                            <div class="stat-label">
                                <%= t('today_volume') %>
                            </div>
                            <div class="stat-value">
                                <span>â‚¹</span><span id="stat-today-vol">0.00</span>
                            </div>
                            <div class="stat-sub"><span id="stat-today-count">0</span> transactions today</div>
                        </div>
                        <div class="stat-card">
                            <i class="ri-history-line stat-icon"></i>
                            <div class="stat-label">
                                <%= t('yesterday_volume') %>
                            </div>
                            <div class="stat-value" style="color: grey;">
                                <span>â‚¹</span><span id="stat-yst-vol">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title"><i class="ri-line-chart-line"></i>
                                    <%= t('volume_trends') %>
                                </div>
                                <span class="badge" style="background:#EEF2FF; color:#4F46E5;">Last 7 Days</span>
                            </div>
                            <div style="padding: 1.5rem; height: 350px;">
                                <canvas id="volumeChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title"><i class="ri-pie-chart-line"></i>
                                    Success Rate
                                </div>
                            </div>
                            <div
                                style="padding: 1.5rem; height: 350px; display:flex; align-items:center; justify-content:center;">
                                <canvas id="successRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payin History Tab -->
                <div id="tab-payin" class="tab-content">
                    <h1>
                        <%= t('payin_history') %>
                    </h1>
                    <div class="subtitle">View all incoming payment transactions.</div>

                    <div class="card"
                        style="padding: 1.25rem; margin-bottom: 1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
                        <input type="date" id="payin-filter-start" class="form-control" style="width: auto;">
                        <input type="date" id="payin-filter-end" class="form-control" style="width: auto;">
                        <select id="payin-filter-status" class="form-control" style="width: auto;">
                            <option value="">All Status</option>
                            <option value="success">Success</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadPayinHistory()"><i class="ri-filter-3-line"></i>
                            Filter</button>
                        <button class="btn" style="background:#E5E7EB;" onclick="exportOrders('payin')"><i
                                class="ri-download-2-line"></i> Export CSV</button>
                    </div>

                    <div class="card">
                        <table id="payin-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="payin-pagination"
                        style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem; align-items:center;">
                    </div>
                </div>

                <!-- Payout History Tab -->
                <div id="tab-payout" class="tab-content">
                    <h1>
                        <%= t('payout_history') %>
                    </h1>
                    <div class="subtitle">View transaction history for all payouts.</div>

                    <div class="card"
                        style="padding: 1.25rem; margin-bottom: 1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
                        <input type="date" id="payout-filter-start" class="form-control" style="width: auto;">
                        <input type="date" id="payout-filter-end" class="form-control" style="width: auto;">
                        <select id="payout-filter-status" class="form-control" style="width: auto;">
                            <option value="">All Status</option>
                            <option value="success">Success</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadPayoutHistory()"><i class="ri-filter-3-line"></i>
                            Filter</button>
                        <button class="btn" style="background:#E5E7EB;" onclick="exportOrders('payout')"><i
                                class="ri-download-2-line"></i> Export CSV</button>
                    </div>

                    <div class="card">
                        <table id="payout-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="payout-pagination"
                        style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem; align-items:center;">
                    </div>
                </div>

                <!-- Settlements Tab -->
                <div id="tab-settlements" class="tab-content">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h1>
                                <%= t('settlements') %>
                            </h1>
                            <div class="subtitle">Manage settlement requests and history.</div>
                        </div>
                        <button class="btn btn-primary" onclick="openSettlementModal()">
                            <i class="ri-add-line"></i>
                            <%= t('request_settlement') %>
                        </button>
                    </div>

                    <div class="card" style="padding: 2rem; margin-bottom: 1.5rem;">
                        <form id="settle-form" onsubmit="requestSettlement(event)">
                            <div
                                style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label class="stat-label">Settlement Amount (â‚¹)</label>
                                    <input type="number" id="s-amount" class="form-control" required min="100">
                                </div>
                                <div>
                                    <label class="stat-label">Settlement Type</label>
                                    <select id="s-type" class="form-control" onchange="checkSettleType()">
                                        <option value="bank">Bank Transfer (IMPS/NEFT)</option>
                                        <option value="usdt">USDT (TRC20)</option>
                                    </select>
                                    <small id="usdt-note"
                                        style="color:var(--danger); display:none; font-size:0.75rem; margin-top:0.25rem;">Minimum
                                        â‚¹100,000 for USDT settlement.</small>
                                </div>
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <label class="stat-label">
                                    <%= t('notes') %>
                                </label>
                                <textarea id="s-notes" class="form-control" rows="3"
                                    placeholder="Enter bank details if not saved, or USDT address for USDT settlements..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center;">
                                <%= t('btn_request_settlement') %>
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <table id="settlement-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>UTR / Notes</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="settlements-pagination"
                        style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem; align-items:center;">
                    </div>
                </div>

                <!-- PayLink Tab -->
                <div id="tab-paylink" class="tab-content">
                    <h1>
                        <%= t('payment_link') %>
                    </h1>
                    <div class="subtitle">Generate direct payment links for your customers.</div>

                    <div class="card" style="max-width: 600px;">
                        <div class="card-header">
                            <div class="card-title"><i class="ri-link-m"></i>
                                <%= t('create_new_link') %>
                            </div>
                        </div>
                        <div style="padding: 2rem;">
                            <form onsubmit="generatePayLink(event)">
                                <div style="margin-bottom:1.5rem;">
                                    <label class="stat-label">
                                        <%= t('amount') %>
                                    </label>
                                    <div
                                        style="display:flex; align-items:center; background:#F9FAFB; border:1px solid #E5E7EB; border-radius:0.5rem; overflow:hidden;">
                                        <div
                                            style="padding:0.75rem; background:#F3F4F6; color:#6B7280; font-weight:600;">
                                            â‚¹</div>
                                        <input type="number" id="link-amount"
                                            style="border:none; padding:0.75rem; flex:1; outline:none; background:transparent;"
                                            required min="10" placeholder="0.00">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary"
                                    style="width:100%; justify-content:center;">
                                    <%= t('generate_link') %> <i class="ri-arrow-right-line"></i>
                                </button>
                            </form>

                            <div id="paylink-result" style="display: none; margin-top: 2rem;">
                                <div style="background:var(--success); padding:1px; border-radius:0.5rem; opacity:0.1;">
                                </div>
                                <div
                                    style="background:#ECFDF5; padding:1.5rem; border-radius:0.5rem; border:1px solid #D1FAE5;">
                                    <label
                                        style="font-size: 0.75rem; color: #059669; font-weight:600; text-transform:uppercase; margin-bottom: 0.5rem; display:block;">Ready
                                        to Share</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="generated-link" class="form-control" readonly
                                            style="background: white;">
                                        <button class="btn btn-primary" onclick="copyLink()"><i
                                                class="ri-file-copy-line"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div id="tab-profile" class="tab-content">
                    <h1>
                        <%= t('profile_settings') %>
                    </h1>
                    <div class="subtitle">Manage your API credentials and channel rates.</div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="ri-key-2-line"></i> API Credentials</div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom:1.5rem;">
                                <label class="stat-label">Merchant ID (x-merchant-id)</label>
                                <div style="display:flex; gap:0.5rem;">
                                    <input type="text" class="form-control" value="<%= user.apiKey %>" readonly
                                        style="font-family: monospace; background:#F3F4F6;">
                                    <button class="btn" style="background:#E5E7EB;"
                                        onclick="navigator.clipboard.writeText('<%= user.apiKey %>')"><i
                                            class="ri-file-copy-line"></i></button>
                                </div>
                                <small style="color: #6B7280; margin-top:0.25rem; display:block;">Include this in your
                                    API headers.</small>
                            </div>

                            <div style="margin-bottom:1.5rem;">
                                <label class="stat-label">API Secret</label>
                                <div style="position:relative;">
                                    <div class="blur-text form-control"
                                        style="font-family: monospace; background:#F3F4F6;"
                                        onclick="this.classList.remove('blur-text')">
                                        <%= user.apiSecret %>
                                    </div>
                                    <div
                                        style="position:absolute; right:1rem; top:50%; transform:translateY(-50%); font-size:0.75rem; color:#9CA3AF; pointer-events:none;">
                                        Click to reveal</div>
                                </div>
                                <small style="color: #6B7280; margin-top:0.25rem; display:block;">Never share this
                                    secret key.</small>
                            </div>

                            <div
                                style="padding:1rem; background:#DBEAFE; border-radius:0.5rem; color:#1E40AF; font-size:0.875rem; display:flex; gap:0.75rem;">
                                <i class="ri-information-fill" style="font-size:1.25rem;"></i>
                                <div>
                                    <strong>Documentation:</strong> Check our <a href="/docs"
                                        style="color:inherit; text-decoration:underline;">API Documentation</a> for
                                    integration guide.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><i class="ri-percent-line"></i> Active Rates</div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <% let rates={}; try { rates=JSON.parse(user.channel_rates || '{}' ); } catch(e) {} %>
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem;">
                                    <div
                                        style="padding: 1.5rem; background: #F9FAFB; border-radius: 0.75rem; text-align:center;">
                                        <div class="stat-label">Payin Fee</div>
                                        <div class="stat-value"
                                            style="justify-content:center; color:var(--primary); font-size:1.5rem;">
                                            <%= rates.payinRate || 5 %>%
                                        </div>
                                    </div>
                                    <div
                                        style="padding: 1.5rem; background: #F9FAFB; border-radius: 0.75rem; text-align:center;">
                                        <div class="stat-label">Payout Fee</div>
                                        <div class="stat-value"
                                            style="justify-content:center; color:var(--danger); font-size:1.5rem;">
                                            <%= rates.payoutRate || 3 %>%
                                        </div>
                                    </div>
                                    <div
                                        style="padding: 1.5rem; background: #F9FAFB; border-radius: 0.75rem; text-align:center;">
                                        <div class="stat-label">Fixed Fee</div>
                                        <div class="stat-value" style="justify-content:center; font-size:1.5rem;">â‚¹<%=
                                                rates.payoutFixedFee || 6 %>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>

                    <!-- Support Card -->
                    <div class="card" style="margin-top: 1.5rem; border: 1px solid #4F46E5; background: #EEF2FF;">
                        <div style="padding:1.5rem; display:flex; align-items:center; gap:1.5rem;">
                            <div style="font-size:2.5rem; color:#4F46E5;">
                                <i class="ri-customer-service-2-line"></i>
                            </div>
                            <div>
                                <h3 style="color:#1E1B4B; margin-bottom: 0.25rem;">Need Assistance?</h3>
                                <p style="color:#4338CA; font-size:0.875rem; margin-bottom:1rem;">Contact our support
                                    team for any integration or settlement issues.</p>
                                <a href="https://t.me/vspay_support" target="_blank" class="btn btn-primary"
                                    style="padding: 0.5rem 1rem;">
                                    <i class="ri-telegram-fill"></i> Contact Support
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Settlement Modal -->
    <div id="settleModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index:100;">
        <div
            style="background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                <h3 style="font-size:1.25rem;">Request Settlement</h3>
                <i class="ri-close-line" style="cursor:pointer; font-size:1.5rem;"
                    onclick="document.getElementById('settleModal').style.display='none'"></i>
            </div>

            <form onsubmit="submitSettlement(event)">
                <div style="margin-bottom:1.5rem;">
                    <label class="stat-label">Amount (â‚¹)</label>
                    <input type="number" id="settle-amount" class="form-control" required min="100"
                        max="<%= user.balance %>" placeholder="Enter amount">
                    <div
                        style="margin-top:0.5rem; font-size:0.75rem; color:var(--text-light); display:flex; justify-content:space-between;">
                        <span>Available Balance</span>
                        <span style="font-weight:600; color:var(--success);">â‚¹<%= parseFloat(user.balance).toFixed(2) %>
                        </span>
                    </div>
                </div>
                <div style="margin-bottom:1.5rem;">
                    <label class="stat-label">Bank Details / Notes</label>
                    <textarea id="settle-notes" class="form-control" rows="3"
                        placeholder="Enter Account Number, IFSC, etc."></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1; justify-content:center;">Submit
                        Request</button>
                    <button type="button" class="btn"
                        onclick="document.getElementById('settleModal').style.display='none'"
                        style="background: #F3F4F6; flex:1; justify-content:center;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Pagination Helper
        function renderPagination(paging, containerId, clickActionTemplate) {
            const container = document.getElementById(containerId);
            if (!paging || paging.pages <= 1) { container.innerHTML = ''; return; }

            const prevAction = clickActionTemplate.replace('{page}', paging.page - 1);
            const nextAction = clickActionTemplate.replace('{page}', paging.page + 1);

            container.innerHTML = `
                <span style="font-size:0.875rem; color:grey; margin-right:auto;">Page ${paging.page} of ${paging.pages} (${paging.total} items)</span>
                <button class="btn" style="padding:0.25rem 0.75rem; background:${paging.page > 1 ? 'white' : '#F3F4F6'}; border:1px solid #E5E7EB;" 
                    onclick="${prevAction}" ${paging.page <= 1 ? 'disabled' : ''}><i class="ri-arrow-left-s-line"></i></button>
                <button class="btn" style="padding:0.25rem 0.75rem; background:${paging.page < paging.pages ? 'white' : '#F3F4F6'}; border:1px solid #E5E7EB;" 
                    onclick="${nextAction}" ${paging.page >= paging.pages ? 'disabled' : ''}><i class="ri-arrow-right-s-line"></i></button>
            `;
        }
        // ... Same Logic as before, just UI structure change ...

        switchTab('dashboard');
        loadStats();

        // Mobile Toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('active');
        }

        let chartInstance = null;
        let successChartInstance = null;

        function checkSettleType() {
            const type = document.getElementById('s-type').value;
            document.getElementById('usdt-note').style.display = type === 'usdt' ? 'block' : 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Close mobile menu on click
            if (window.innerWidth <= 1024) toggleSidebar();

            event && event.currentTarget.classList.add('active'); // Use currentTarget for div click

            if (tab === 'payin') loadOrders('payin');
            if (tab === 'payout') loadOrders('payout');
            if (tab === 'settlements') loadSettlements();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/merchant/stats');
                const data = await res.json();
                if (data.success) {
                    const s = data.stats;
                    document.getElementById('stat-today-vol').innerText = s.today.payin.toFixed(2);
                    document.getElementById('stat-today-count').innerText = s.today.payinSuccessCount;
                    document.getElementById('stat-yst-vol').innerText = s.yesterday.payin.toFixed(2);

                    renderSuccessChart(s.today.payinSuccessCount, s.today.payinFailedCount + s.today.payinPendingCount);
                }
                loadChart();
            } catch (e) { console.error(e); }
        }

        function renderSuccessChart(success, failed) {
            const ctx = document.getElementById('successRateChart').getContext('2d');
            if (successChartInstance) successChartInstance.destroy();

            const total = success + failed;
            const rate = total > 0 ? ((success / total) * 100).toFixed(1) : 0;

            successChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Other'],
                    datasets: [{
                        data: [success, failed || 1], // dummy 1 if both 0 for visual
                        backgroundColor: ['#10B981', '#E5E7EB'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: total > 0 }
                    }
                },
                plugins: [{
                    id: 'text',
                    beforeDraw: function (chart) {
                        var width = chart.width, height = chart.height, ctx = chart.ctx;
                        ctx.restore();
                        var fontSize = (height / 114).toFixed(2);
                        ctx.font = fontSize + "em sans-serif";
                        ctx.textBaseline = "middle";
                        var text = rate + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });
        }

        async function loadChart() {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            const res = await fetch('/api/merchant/chart');
            const data = await res.json();

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Payin', data: data.payinData, borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Payout', data: data.payoutData, borderColor: '#EF4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                }
            });
        }

        async function loadOrders(type, page = 1) {
            const tbody = document.getElementById(type + '-table').querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="4"><div style="text-align:center; padding:2rem; color:grey;"><i class="ri-loader-4-line ri-spin"></i> Loading...</div></td></tr>';

            const start = document.getElementById(type + '-filter-start').value;
            const end = document.getElementById(type + '-filter-end').value;
            const status = document.getElementById(type + '-filter-status').value;

            let url = `/api/merchant/orders?type=${type}&page=${page}`;
            if (start) url += `&startDate=${start}`;
            if (end) url += `&endDate=${end}`;
            if (status) url += `&status=${status}`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.success && data.orders.length > 0) {
                    tbody.innerHTML = data.orders.map(o => `
                        <tr>
                            <td style="font-family:monospace; font-weight:600;">#${o.orderId.substring(0, 8)}...</td>
                            <td>â‚¹${o.amount} ${o.payoutType === 'usdt' ? '<small>(USDT)</small>' : ''}</td>
                            <td><span class="badge badge-${o.status}">${o.status}</span></td>
                            <td>${new Date(o.createdAt).toLocaleDateString()}</td>
                        </tr>
                    `).join('');

                    renderPagination(data.pagination, type + '-pagination', `loadOrders('${type}', {page})`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #9ca3af; padding:2rem;">No transactions found</td></tr>';
                    document.getElementById(type + '-pagination').innerHTML = '';
                }
            } catch (e) { console.error(e); }
        }

        function exportOrders(type) {
            const start = document.getElementById(type + '-filter-start').value;
            const end = document.getElementById(type + '-filter-end').value;
            const status = document.getElementById(type + '-filter-status').value;

            let url = `/api/merchant/export/orders?type=${type}`;
            if (start) url += `&startDate=${start}`;
            if (end) url += `&endDate=${end}`;
            if (status) url += `&status=${status}`;

            window.location.href = url;
        }

        function loadPayinHistory(page) { loadOrders('payin', page); }
        function loadPayoutHistory(page) { loadOrders('payout', page); }

        async function loadSettlements(page = 1) {
            const tbody = document.getElementById('settlement-table').querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="5"><div style="text-align:center; padding:2rem; color:grey;"><i class="ri-loader-4-line ri-spin"></i> Loading...</div></td></tr>';

            try {
                const res = await fetch(`/api/merchant/settlements?page=${page}`);
                const data = await res.json();

                if (data.success && data.settlements.length > 0) {
                    tbody.innerHTML = data.settlements.map(s => `
                        <tr>
                            <td style="font-family:monospace;">#${s.id.substring(0, 8)}</td>
                            <td style="font-weight:600;">â‚¹${s.amount}</td>
                            <td><span class="badge badge-${s.status}">${s.status}</span></td>
                            <td>
                                ${s.utr ? `<div style="font-size:0.75rem; color:var(--text-light);">UTR: ${s.utr}</div>` : ''}
                                ${s.notes ? `<div style="font-size:0.75rem;">${s.notes}</div>` : ''}
                            </td>
                            <td>${new Date(s.createdAt).toLocaleDateString()}</td>
                        </tr>
                    `).join('');

                    renderPagination(data.pagination, 'settlements-pagination', `loadSettlements({page})`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af; padding:2rem;">No settlements yet</td></tr>';
                    document.getElementById('settlements-pagination').innerHTML = '';
                }
            } catch (e) { console.error(e); }
        }

        function openSettlementModal() {
            document.getElementById('settleModal').style.display = 'flex';
        }

        async function requestSettlement(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Processing...';
            btn.disabled = true;

            const amount = document.getElementById('s-amount').value;
            const notes = document.getElementById('s-notes').value;
            const type = document.getElementById('s-type').value;

            try {
                const res = await fetch('/api/merchant/settlements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, notes, type })
                });

                const data = await res.json();
                if (data.success) {
                    e.target.reset();
                    loadSettlements();
                    // Update balance text
                    const currentBal = parseFloat(document.getElementById('stat-balance').innerText);
                    document.getElementById('stat-balance').innerText = (currentBal - parseFloat(amount)).toFixed(2);
                    alert('Settlement request submitted successfully');
                } else {
                    alert(data.error);
                }
            } catch (e) { alert('Error submitting request'); }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function submitSettlement(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Processing...';
            btn.disabled = true;

            const amount = document.getElementById('settle-amount').value;
            const notes = document.getElementById('settle-notes').value;

            try {
                const res = await fetch('/api/merchant/settlements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, notes, type: 'bank' })
                });

                const data = await res.json();
                if (data.success) {
                    document.getElementById('settleModal').style.display = 'none';
                    loadSettlements();
                    // Update balance text
                    const currentBal = parseFloat(document.getElementById('stat-balance').innerText);
                    document.getElementById('stat-balance').innerText = (currentBal - parseFloat(amount)).toFixed(2);
                } else {
                    alert(data.error);
                }
            } catch (e) { alert('Error submitting request'); }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function generatePayLink(e) {
            e.preventDefault();
            const amount = document.getElementById('link-amount').value;
            const res = await fetch('/api/merchant/paylink', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('generated-link').value = data.link;
                document.getElementById('paylink-result').style.display = 'block';
            }
        }

        function copyLink() {
            const el = document.getElementById('generated-link');
            el.select();
            document.execCommand('copy');
            alert('Copied!');
        }
    </script>
</body>

</html>